<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Visual Photo Editor</title>
    <style>
        body { font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; display: flex; gap: 2em; padding: 2em; background-color: #f4f4f9; }
        .controls { width: 350px; flex-shrink: 0; background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .controls h1 { margin-top: 0; }
        #editor-container { position: relative; flex-grow: 1; border: 2px dashed #ccc; background-size: contain; background-repeat: no-repeat; background-position: center; }
        .draggable { position: absolute; cursor: grab; border: 1px dotted rgba(0, 123, 255, 0.7); user-select: none; }
        .draggable:active { cursor: grabbing; }
        #logo-wrapper img { width: 150px; pointer-events: none; } /* Lebar default logo di preview */
        #text-wrapper { padding: 5px; white-space: nowrap; font-weight: bold; }
        button { width: 100%; background-color: #007bff; color: white; padding: 12px; border: none; border-radius: 5px; cursor: pointer; margin-top: 1em; font-size: 16px; }
        button:hover { background-color: #0056b3; }
        #preview-button { background-color: #28a745; }
        #preview-button:hover { background-color: #218838; }
        #preview-button:disabled { background-color: #ccc; cursor: not-allowed; }

        /* Modal Preview */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); justify-content: center; align-items: center; }
        .modal-content { background-color: #fff; padding: 20px; border-radius: 8px; width: 80%; max-width: 700px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .modal-content img { max-width: 100%; border: 1px solid #ddd; margin-bottom: 15px; }
        .close-button { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        #final-download-link { display: inline-block; text-decoration: none; font-size: 16px; }
    </style>
</head>
<body>

    <div class="controls">
        <h1>Mode Kreasi</h1>
        <form id="editor-form">
            {% csrf_token %}
            {{ form.as_p }}
        </form>
        <button type="button" id="preview-button">Lihat Preview Final</button>
    </div>

    <div id="editor-container">
        <div id="logo-wrapper" class="draggable" style="display:none;"><img id="logo-preview" src="" alt="Logo Preview"></div>
        <div id="text-wrapper" class="draggable">Sample Text</div>
    </div>

    <div id="preview-modal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2>Preview Final</h2>
            <img id="final-preview-image" src="" alt="Final Preview">
            <a id="final-download-link" href="#" download="hasil-kreasi.jpg" class="button">Download Gambar Ini</a>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/Draggable.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const editorForm = document.getElementById('editor-form');
            const baseImageInput = document.getElementById('base_image_input');
            const logoImageInput = document.getElementById('logo_image_input');
            const textInput = document.getElementById('text_input');
            const fontSizeInput = document.getElementById('font_size_input');
            const editorContainer = document.getElementById('editor-container');
            const logoWrapper = document.getElementById('logo-wrapper');
            const textWrapper = document.getElementById('text-wrapper');
            const logoPreview = document.getElementById('logo-preview');
            const textXInput = document.getElementById('text_x_input');
            const textYInput = document.getElementById('text_y_input');
            const logoXInput = document.getElementById('logo_x_input');
            const logoYInput = document.getElementById('logo_y_input');
            const logoWInput = document.getElementById('logo_w_input');
            const logoHInput = document.getElementById('logo_h_input');
            let scaleX = 1, scaleY = 1;

            baseImageInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const editorWidth = editorContainer.clientWidth;
                        const editorHeight = editorContainer.clientHeight;
                        const editorRatio = editorWidth / editorHeight;
                        const imgRatio = img.naturalWidth / img.naturalHeight;
                        let renderedWidth, renderedHeight;
                        if (editorRatio > imgRatio) {
                            renderedHeight = editorHeight;
                            renderedWidth = renderedHeight * imgRatio;
                        } else {
                            renderedWidth = editorWidth;
                            renderedHeight = renderedWidth / imgRatio;
                        }
                        scaleX = img.naturalWidth / renderedWidth;
                        scaleY = img.naturalHeight / renderedHeight;
                    };
                    img.src = e.target.result;
                    editorContainer.style.backgroundImage = `url(${e.target.result})`;
                };
                reader.readAsDataURL(file);
            });

            logoImageInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    logoPreview.src = URL.createObjectURL(file);
                    logoWrapper.style.display = 'block';
                }
            });

            textInput.addEventListener('input', (e) => { textWrapper.textContent = e.target.value; });
            fontSizeInput.addEventListener('input', (e) => { textWrapper.style.fontSize = `${e.target.value}px`; });

            function updateDraggable(elementId, xInput, yInput, wInput, hInput) {
                Draggable.create(elementId, {
                    bounds: "#editor-container",
                    onDragEnd: function() {
                        xInput.value = Math.round(this.x * scaleX);
                        yInput.value = Math.round(this.y * scaleY);
                        if(wInput && hInput) {
                             const rect = this.target.getBoundingClientRect();
                             wInput.value = Math.round(rect.width * scaleX);
                             hInput.value = Math.round(rect.height * scaleY);
                        }
                    }
                });
            }
            updateDraggable("#text-wrapper", textXInput, textYInput);
            updateDraggable("#logo-wrapper", logoXInput, logoYInput, logoWInput, logoHInput);

            // AJAX Preview Logic
            const previewButton = document.getElementById('preview-button');
            const modal = document.getElementById('preview-modal');
            const finalPreviewImage = document.getElementById('final-preview-image');
            const finalDownloadLink = document.getElementById('final-download-link');
            const closeButton = document.querySelector('.close-button');

            previewButton.addEventListener('click', () => {
                previewButton.textContent = 'Memproses...';
                previewButton.disabled = true;

                const formData = new FormData(editorForm);
                const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

                fetch("{% url 'ajax_generate_preview' %}", {
                    method: 'POST',
                    headers: { 'X-CSRFToken': csrftoken },
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const imageDataUrl = `data:image/jpeg;base64,${data.image_data}`;
                        finalPreviewImage.src = imageDataUrl;
                        finalDownloadLink.href = imageDataUrl;
                        modal.style.display = 'flex';
                    } else {
                        alert('Terjadi kesalahan: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Gagal menghubungi server.');
                })
                .finally(() => {
                    previewButton.textContent = 'Lihat Preview Final';
                    previewButton.disabled = false;
                });
            });

            closeButton.onclick = () => { modal.style.display = "none"; }
            window.onclick = (event) => {
                if (event.target == modal) {
                    modal.style.display = "none";
                }
            }
        });
    </script>
</body>
</html>